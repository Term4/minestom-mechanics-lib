package com.minestom.mechanics.systems.health.tags;

import net.minestom.server.tag.Tag;
import net.minestom.server.tag.TagReadable;
import net.minestom.server.tag.TagSerializer;
import net.minestom.server.tag.TagWritable;
import org.jetbrains.annotations.NotNull;

/**
 * Serializer for InvulnerabilityTagWrapper
 * Handles MULTIPLIER, MODIFY, and CUSTOM fields
 */
public class InvulnerabilityTagSerializer implements TagSerializer<InvulnerabilityTagWrapper> {
    
    private static final String MULT_KEY = "m";
    private static final String MOD_KEY = "d";
    private static final String HAS_CUSTOM_KEY = "has_custom";
    private static final String C_TICKS_KEY = "ct";
    private static final String C_REPLACEMENT_KEY = "cr";
    private static final String C_KNOCKBACK_KEY = "ck";
    private static final String C_BYPASS_KEY = "cb";
    private static final String C_BYPASS_CREATIVE_KEY = "cc";
    private static final String C_BYPASS_CREATIVE_MELEE_KEY = "cm";

    @Override
    public InvulnerabilityTagWrapper read(@NotNull TagReadable reader) {
        // Read multiplier list (not used for invulnerability, but kept for consistency)
        java.util.List<Double> multiplier = reader.getTag(Tag.Double(MULT_KEY).list());

        // Read modify list (not used for invulnerability, but kept for consistency)
        java.util.List<Double> modify = reader.getTag(Tag.Double(MOD_KEY).list());

        // Read custom config if present
        InvulnerabilityTagValue custom = null;
        Boolean hasCustom = reader.getTag(Tag.Boolean(HAS_CUSTOM_KEY));
        if (Boolean.TRUE.equals(hasCustom)) {
            Integer ticks = reader.getTag(Tag.Integer(C_TICKS_KEY));
            Boolean replacement = reader.getTag(Tag.Boolean(C_REPLACEMENT_KEY));
            Boolean knockback = reader.getTag(Tag.Boolean(C_KNOCKBACK_KEY));
            Boolean bypass = reader.getTag(Tag.Boolean(C_BYPASS_KEY));
            Boolean bypassCreative = reader.getTag(Tag.Boolean(C_BYPASS_CREATIVE_KEY));
            Boolean bypassCreativeMelee = reader.getTag(Tag.Boolean(C_BYPASS_CREATIVE_MELEE_KEY));
            custom = new InvulnerabilityTagValue(ticks, replacement, knockback, bypass, bypassCreative, bypassCreativeMelee);
        }

        return new InvulnerabilityTagWrapper(multiplier, modify, custom);
    }
    
    @Override
    public void write(@NotNull TagWritable writer, @NotNull InvulnerabilityTagWrapper wrapper) {
        // Write multiplier list (not used, but kept for consistency)
        if (wrapper.multiplier() != null && !wrapper.multiplier().isEmpty()) {
            writer.setTag(Tag.Double(MULT_KEY).list(), wrapper.multiplier());
        }
        
        // Write modify list (not used, but kept for consistency)
        if (wrapper.modify() != null && !wrapper.modify().isEmpty()) {
            writer.setTag(Tag.Double(MOD_KEY).list(), wrapper.modify());
        }
        
        // Write custom config if present
        if (wrapper.custom() != null) {
            writer.setTag(Tag.Boolean(HAS_CUSTOM_KEY), true);
            InvulnerabilityTagValue custom = wrapper.custom();
            if (custom.invulnerabilityTicks() != null) {
                writer.setTag(Tag.Integer(C_TICKS_KEY), custom.invulnerabilityTicks());
            }
            if (custom.damageReplacementEnabled() != null) {
                writer.setTag(Tag.Boolean(C_REPLACEMENT_KEY), custom.damageReplacementEnabled());
            }
            if (custom.knockbackOnReplacement() != null) {
                writer.setTag(Tag.Boolean(C_KNOCKBACK_KEY), custom.knockbackOnReplacement());
            }
            if (custom.bypassInvulnerability() != null) {
                writer.setTag(Tag.Boolean(C_BYPASS_KEY), custom.bypassInvulnerability());
            }
            if (custom.bypassCreativeInvulnerability() != null) {
                writer.setTag(Tag.Boolean(C_BYPASS_CREATIVE_KEY), custom.bypassCreativeInvulnerability());
            }
            if (custom.bypassCreativeMelee() != null) {
                writer.setTag(Tag.Boolean(C_BYPASS_CREATIVE_MELEE_KEY), custom.bypassCreativeMelee());
            }
        }
    }
}

